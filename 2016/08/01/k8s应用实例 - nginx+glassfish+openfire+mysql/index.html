<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhanghonged.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.14.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="最近手上有个项目，是nginx+glassfish+openfire+mysql架构，刚好近期在学习kubernets，现学现用，先把此项目在k8s上跑起来。此项目架构图如下：">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s应用实例 - nginx+glassfish+openfire+mysql">
<meta property="og:url" content="http://zhanghonged.github.io/2016/08/01/k8s%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B%20-%20nginx+glassfish+openfire+mysql/index.html">
<meta property="og:site_name" content="勇敢的心">
<meta property="og:description" content="最近手上有个项目，是nginx+glassfish+openfire+mysql架构，刚好近期在学习kubernets，现学现用，先把此项目在k8s上跑起来。此项目架构图如下：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://zhanghonged.github.io/uploads/shili2-1.jpg">
<meta property="og:image" content="http://zhanghonged.github.io/uploads/shili2-2.png">
<meta property="article:published_time" content="2016-08-01T07:00:17.000Z">
<meta property="article:modified_time" content="2016-08-09T08:36:49.810Z">
<meta property="article:author" content="张大秀">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="实例">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://zhanghonged.github.io/uploads/shili2-1.jpg">


<link rel="canonical" href="http://zhanghonged.github.io/2016/08/01/k8s%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B%20-%20nginx+glassfish+openfire+mysql/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://zhanghonged.github.io/2016/08/01/k8s%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B%20-%20nginx+glassfish+openfire+mysql/","path":"2016/08/01/k8s应用实例 - nginx+glassfish+openfire+mysql/","title":"k8s应用实例 - nginx+glassfish+openfire+mysql"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s应用实例 - nginx+glassfish+openfire+mysql | 勇敢的心</title>
  






  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">勇敢的心</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section">归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section">分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section">标签</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="nav-number">1.</span> <span class="nav-text">环境要求:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#K8s%E6%9E%B6%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">K8s架构:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%96%BD%EF%BC%9A"><span class="nav-number">3.</span> <span class="nav-text">部署实施：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="nav-number">3.1.</span> <span class="nav-text">一、前期准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E3%80%81mysql%E9%83%A8%E7%BD%B2"><span class="nav-number">3.2.</span> <span class="nav-text">二、mysql部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F"><span class="nav-number">3.2.1.</span> <span class="nav-text">1、下载镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BAmysql%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">3.2.2.</span> <span class="nav-text">2、创建mysql数据持久化存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81mysql-rc%E5%92%8Csvc%E7%9A%84yaml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.3.</span> <span class="nav-text">3、mysql rc和svc的yaml配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96mysql%E6%95%B0%E6%8D%AE"><span class="nav-number">3.2.4.</span> <span class="nav-text">4、初始化mysql数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81glassfish%E9%83%A8%E7%BD%B2"><span class="nav-number">3.3.</span> <span class="nav-text">三、glassfish部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F-1"><span class="nav-number">3.3.1.</span> <span class="nav-text">1、下载镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F"><span class="nav-number">3.3.2.</span> <span class="nav-text">2、自定义镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%88%9B%E5%BB%BAJEE%E5%BA%94%E7%94%A8%E7%9A%84%E6%8C%81%E7%BB%AD%E5%AD%98%E5%82%A8"><span class="nav-number">3.3.3.</span> <span class="nav-text">3、创建JEE应用的持续存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E9%83%A8%E7%BD%B2glassfish"><span class="nav-number">3.3.4.</span> <span class="nav-text">4、部署glassfish</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81openfire%E9%83%A8%E7%BD%B2"><span class="nav-number">3.4.</span> <span class="nav-text">三、openfire部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BDjdk%E9%95%9C%E5%83%8F"><span class="nav-number">3.4.1.</span> <span class="nav-text">1、下载jdk镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="nav-number">3.4.2.</span> <span class="nav-text">2、创建镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E5%BC%80%E5%A7%8B%E9%83%A8%E7%BD%B2openfire"><span class="nav-number">3.4.3.</span> <span class="nav-text">6、开始部署openfire</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81nginx%E9%83%A8%E7%BD%B2"><span class="nav-number">3.5.</span> <span class="nav-text">四、nginx部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F-2"><span class="nav-number">3.5.1.</span> <span class="nav-text">1、下载镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="nav-number">3.5.2.</span> <span class="nav-text">2、构建镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%88%9B%E5%BB%BAnginx%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8pv%E5%8F%8Apvc"><span class="nav-number">3.5.3.</span> <span class="nav-text">3、创建nginx的持久化存储pv及pvc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E4%BD%BF%E7%94%A8kubectl-create-%E6%9D%A5%E8%BF%9B%E8%A1%8C%E9%83%A8%E7%BD%B2"><span class="nav-number">3.5.4.</span> <span class="nav-text">4、使用kubectl create 来进行部署</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E5%8F%91%E5%B8%83"><span class="nav-number">4.</span> <span class="nav-text">程序发布:</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="张大秀"
      src="/uploads/inter.png">
  <p class="site-author-name" itemprop="name">张大秀</p>
  <div class="site-description" itemprop="description">富贾，可为吾友乎？</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">136</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">89</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="http://www.docker.org.cn/" title="docker中文社区 → http:&#x2F;&#x2F;www.docker.org.cn&#x2F;" rel="noopener" target="_blank">docker中文社区</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://man.linuxde.net/" title="Linux命令大全 → http:&#x2F;&#x2F;man.linuxde.net&#x2F;" rel="noopener" target="_blank">Linux命令大全</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.eryajf.net/" title="二丫讲梵 → http:&#x2F;&#x2F;www.eryajf.net&#x2F;" rel="noopener" target="_blank">二丫讲梵</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.liaoxuefeng.com/" title="廖雪峰 → http:&#x2F;&#x2F;www.liaoxuefeng.com&#x2F;" rel="noopener" target="_blank">廖雪峰</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.cnblogs.com/vamei/" title="vamei博客 → http:&#x2F;&#x2F;www.cnblogs.com&#x2F;vamei&#x2F;" rel="noopener" target="_blank">vamei博客</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.cnblogs.com/horizonli/" title="my_cool2007 → http:&#x2F;&#x2F;www.cnblogs.com&#x2F;horizonli&#x2F;" rel="noopener" target="_blank">my_cool2007</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://islocal.cc/" title="P&#39;sir → http:&#x2F;&#x2F;islocal.cc" rel="noopener" target="_blank">P'sir</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://iit.im/" title="洁身 → http:&#x2F;&#x2F;iit.im&#x2F;" rel="noopener" target="_blank">洁身</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://zhangguanzhang.github.io/" title="张馆长 → https:&#x2F;&#x2F;zhangguanzhang.github.io&#x2F;" rel="noopener" target="_blank">张馆长</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://lework.github.io/" title="lework → https:&#x2F;&#x2F;lework.github.io&#x2F;" rel="noopener" target="_blank">lework</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.ruanyifeng.com/" title="阮一峰 → http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;" rel="noopener" target="_blank">阮一峰</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhanghonged.github.io/2016/08/01/k8s%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B%20-%20nginx+glassfish+openfire+mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/inter.png">
      <meta itemprop="name" content="张大秀">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="勇敢的心">
      <meta itemprop="description" content="富贾，可为吾友乎？">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="k8s应用实例 - nginx+glassfish+openfire+mysql | 勇敢的心">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s应用实例 - nginx+glassfish+openfire+mysql
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-08-01 15:00:17" itemprop="dateCreated datePublished" datetime="2016-08-01T15:00:17+08:00">2016-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-08-09 16:36:49" itemprop="dateModified" datetime="2016-08-09T16:36:49+08:00">2016-08-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B/" itemprop="url" rel="index"><span itemprop="name">k8s应用实例</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>最近手上有个项目，是nginx+glassfish+openfire+mysql架构，刚好近期在学习kubernets，现学现用，先把此项目在k8s上跑起来。<br>此项目架构图如下：<br><img src="/uploads/shili2-1.jpg" alt="jiagou"></p>
<span id="more"></span>

<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求:"></a>环境要求:</h2><p>nginx：稳定版本，具体不要求<br>glassfish：4.0.89<br>openfire：4.0.2<br>mysql：5.6以上</p>
<h2 id="K8s架构"><a href="#K8s架构" class="headerlink" title="K8s架构:"></a>K8s架构:</h2><p>1、nginx、glassfish、openfire、mysql分别部署在一个rc中，各个组件之间使用svc名称来互联，但前提是部署好dns(skydns)。<br>2、采用持久化存储相关数据，我的环境中有nfs文件系统，这里就用nfs在做持久化存储。</p>
<ul>
<li>mysql：持久化数据库存储目录；</li>
<li>glassfish：持久化系统上传的图片、文件路径；</li>
<li>nginx：持久化webapp目录和glassfish的系统上传路径，这里需要使用nginx来读取这些文件，所以只需只读权限。</li>
</ul>
<p>3、mysql部署好之后手动恢复程序需要使用.sql文件，也可以通过重新build images文件自动恢复，这里先不这样做。<br>4、由于主机环境无法使用Loadbalancer方式，这里使用NodePort网络方式来提供用户访问。</p>
<h2 id="部署实施："><a href="#部署实施：" class="headerlink" title="部署实施："></a>部署实施：</h2><h3 id="一、前期准备"><a href="#一、前期准备" class="headerlink" title="一、前期准备"></a>一、前期准备</h3><p>NFS采用现有系统，配置输出目录:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@4 ~]# cat /etc/exports </span><br><span class="line">#mysql</span><br><span class="line">/data/k8s/mysql *(rw,no_root_squash,async)</span><br><span class="line">#glassfish</span><br><span class="line">/data/k8s/gf *(rw,no_root_squash,async)</span><br><span class="line">#nginx</span><br><span class="line">/data/k8s/nginx *(rw,no_root_squash,async)</span><br></pre></td></tr></table></figure>
<h3 id="二、mysql部署"><a href="#二、mysql部署" class="headerlink" title="二、mysql部署"></a>二、mysql部署</h3><h4 id="1、下载镜像"><a href="#1、下载镜像" class="headerlink" title="1、下载镜像"></a>1、下载镜像</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io/mysql:5.7.13</span><br></pre></td></tr></table></figure>
<h4 id="2、创建mysql数据持久化存储"><a href="#2、创建mysql数据持久化存储" class="headerlink" title="2、创建mysql数据持久化存储"></a>2、创建mysql数据持久化存储</h4><p>yaml文件如下：<br><em>mysql-pv.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-mysql</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 500Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    server: 192.168.1.4</span><br><span class="line">    path: &quot;/data/k8s/mysql&quot;</span><br></pre></td></tr></table></figure>
<p><em>mysql-pvc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: mysqlnfs</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 300Mi</span><br></pre></td></tr></table></figure>
<p>通过kubectl命令创建mysql的pv及pvc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f mysql-pv.yaml</span><br><span class="line">kubectl create -f mysql-pvc.yaml</span><br><span class="line">[root@master ~]# kubectl get pv nfs-mysql</span><br><span class="line">NAME        CAPACITY   ACCESSMODES   STATUS    CLAIM              REASON    AGE</span><br><span class="line">nfs-mysql   500Mi      RWX           Bound     default/mysqlnfs             8d</span><br><span class="line">[root@master ~]# kubectl get pvc mysqlnfs</span><br><span class="line">NAME       STATUS    VOLUME      CAPACITY   ACCESSMODES   AGE</span><br><span class="line">mysqlnfs   Bound     nfs-mysql   500Mi      RWX           8d</span><br></pre></td></tr></table></figure>

<h4 id="3、mysql-rc和svc的yaml配置文件"><a href="#3、mysql-rc和svc的yaml配置文件" class="headerlink" title="3、mysql rc和svc的yaml配置文件"></a>3、mysql rc和svc的yaml配置文件</h4><p>为方便使用客户端工具管理mysql，网络类型设置为NodePort<br><em>mysql-rc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: xxx-mysql</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: xxx-mysql</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - resources:</span><br><span class="line">            limits :</span><br><span class="line">              cpu: 0.5</span><br><span class="line">          image: docker.io/mysql:5.7.13</span><br><span class="line">          name: mysql</span><br><span class="line">          env:</span><br><span class="line">            - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">              # change this</span><br><span class="line">              value: abcd1234</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 3306</span><br><span class="line">              name: mysql</span><br><span class="line">          volumeMounts:</span><br><span class="line">              # name must match the volume name below</span><br><span class="line">            - name: mysql-persistent-storage</span><br><span class="line">              # mount path within the container</span><br><span class="line">              mountPath: /var/lib/mysql</span><br><span class="line">      volumes:</span><br><span class="line">        - name: mysql-persistent-storage</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            claimName: mysqlnfs</span><br></pre></td></tr></table></figure>
<p><em>mysql-svc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: xxx-mysql</span><br><span class="line">  name: xxx-mysql</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    # the port that this service should serve on</span><br><span class="line">    - port: 3306</span><br><span class="line">      targetPort: 3306</span><br><span class="line">      nodePort: 30036</span><br><span class="line">  # label keys and values that must match in order to receive traffic for this service</span><br><span class="line">  selector:</span><br><span class="line">    name: xxx-mysql</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>
<p>通过kuectl创建</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f mysql-rc.yaml</span><br><span class="line">kubectl create -f mysql-svc.yaml</span><br></pre></td></tr></table></figure>
<p>创建成功后，在nfs服务器上查看&#x2F;data&#x2F;k8s&#x2F;mysql目录，mysql数据文件已经生成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@4 ~]# ls /data/k8s/mysql/</span><br><span class="line">auto.cnf  ib_buffer_pool  ibdata1  ib_logfile0  ib_logfile1  ibtmp1  mysql  performance_schema  sys</span><br><span class="line">[root@4 ~]#</span><br></pre></td></tr></table></figure>

<h4 id="4、初始化mysql数据"><a href="#4、初始化mysql数据" class="headerlink" title="4、初始化mysql数据"></a>4、初始化mysql数据</h4><p>这里通过手动恢复.sql文件来生成<br>可以kubectl exec进入container手动执行脚本恢复<br>由于mysql网络类型为NodePort，也可以通过客户端连接工具来操作。</p>
<h3 id="三、glassfish部署"><a href="#三、glassfish部署" class="headerlink" title="三、glassfish部署"></a>三、glassfish部署</h3><h4 id="1、下载镜像-1"><a href="#1、下载镜像-1" class="headerlink" title="1、下载镜像"></a>1、下载镜像</h4><p>glassfish要求使用版本4.0.2,这里images直接下载此版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#使用国内的时速云仓库下载比较快</span><br><span class="line">docker pull index.tenxcloud.com/tenxcloud/glassfish:4.0</span><br></pre></td></tr></table></figure>

<h4 id="2、自定义镜像"><a href="#2、自定义镜像" class="headerlink" title="2、自定义镜像"></a>2、自定义镜像</h4><p>此应用通过jdbc连接池连接mysql数据库，这里就需要给glassfish配置好jdbc连接池。<br>我的方法是k8s创建rc的时候通过指定环境变量自动把连接池创建好，所以我们需要对上面下载的glasssfish镜像进行修改并生成新的images。<br>Dockerfile文件如下，由于我们是通过glassfish:4.0镜像来修改的，所以需要修改run.sh启动脚本，增加内容来创建jdbc连接池。<br><em>Dockerfile</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM index.tenxcloud.com/tenxcloud/glassfish:4.0</span><br><span class="line">MAINTAINER zhanghong,zhanghong@16feng.com</span><br><span class="line">#添加glassfish连接mysql的驱动包</span><br><span class="line">ADD mysql-connector-java-5.1.16-bin.jar /opt/glassfish4/glassfish/lib/</span><br><span class="line">#添加创建jdbc连接池的脚本</span><br><span class="line">ADD myjdbc /</span><br><span class="line">RUN echo &quot;Asia/shanghai&quot; &gt; /etc/timezone</span><br><span class="line">RUN mkdir /opt/file/</span><br><span class="line">#把创建jdbc连接池的脚本插入到run.sh脚本中</span><br><span class="line">RUN sed -i &#x27;7 r /myjdbc&#x27; /run.sh</span><br><span class="line">EXPOSE 8080 4848 8181</span><br><span class="line">ENTRYPOINT [&quot;/run.sh&quot;]</span><br></pre></td></tr></table></figure>
<p><em>myjdbc</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># add glass_pass into /etc/gfpwd</span><br><span class="line">echo &quot;AS_ADMIN_PASSWORD=$GLASSFISH_PASS&quot; &gt; /etc/gfpwd</span><br><span class="line"></span><br><span class="line"># create jdbc-connect-pool</span><br><span class="line">asadmin -W /etc/gfpwd create-jdbc-connection-pool --datasourceclassname com.mysql.jdbc.jdbc2.optional.MysqlConnectionPoolDataSource --restype javax.sql.ConnectionPoolDataSource --driverclassname MySql --property User=$DBUSER:Password=$DBPWD:Port=$DBPORT:AutoReconnectForPools=ture:URL=jdbc\\:mysql\\://$DBHOST\\:3306/$DBNAME $JDBC_POOL</span><br><span class="line"></span><br><span class="line"># ping jdbc-connect-pool</span><br><span class="line">asadmin -W /etc/gfpwd ping-connection-pool $JDBC_POOL</span><br><span class="line"></span><br><span class="line"># cerate jdbc-name</span><br><span class="line">asadmin -W /etc/gfpwd create-jdbc-resource --connectionpoolid $JDBC_POOL jdbc/$JDBC_NAME</span><br></pre></td></tr></table></figure>
<p>通过dockerbuild命令生成images：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@minion2 glassfish]# docker build -t glassfish:z1 .</span><br><span class="line">Sending build context to Docker daemon   791 kB</span><br><span class="line">Step 1 : FROM index.tenxcloud.com/tenxcloud/glassfish:4.0</span><br><span class="line"> ---&gt; dedcebceeba7</span><br><span class="line">Step 2 : MAINTAINER zhanghong,zhanghong@16feng.com</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 1412fab78991</span><br><span class="line">Step 3 : ADD mysql-connector-java-5.1.16-bin.jar /opt/glassfish4/glassfish/lib/</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; a39af8a9c2b9</span><br><span class="line">Step 4 : ADD myjdbc /</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 08ceb1929a1d</span><br><span class="line">Step 5 : RUN echo &quot;Asia/shanghai&quot; &gt; /etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 7ce311a6c8d8</span><br><span class="line">Step 6 : RUN mkdir /opt/file/</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5dbb73797e34</span><br><span class="line">Step 7 : RUN sed -i &#x27;7 r /myjdbc&#x27; /run.sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; c73001ffbac3</span><br><span class="line">Step 8 : EXPOSE 8080 4848 8181</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 54aa6da77dcc</span><br><span class="line">Step 9 : ENTRYPOINT /run.sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5e92ea03c19a</span><br><span class="line">Successfully built 5e92ea03c19a</span><br></pre></td></tr></table></figure>

<h4 id="3、创建JEE应用的持续存储"><a href="#3、创建JEE应用的持续存储" class="headerlink" title="3、创建JEE应用的持续存储"></a>3、创建JEE应用的持续存储</h4><p>下面是yaml配置文件：<br><em>gf-pv.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-glassfish</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 300Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    server: 192.168.1.4</span><br><span class="line">    path: &quot;/data/k8s/gf&quot;</span><br></pre></td></tr></table></figure>
<p><em>gf-pvc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: glassfishnfs</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 300Mi</span><br></pre></td></tr></table></figure>
<p>通过kubectl命令创建mysql的pv及pvc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master pvc]# kubectl create -f gf-pv.yaml</span><br><span class="line">[root@master pvc]# kubectl create -f gf-pvc.yaml</span><br><span class="line">[root@master pvc]# kubectl get pv nfs-glassfish</span><br><span class="line">NAME            CAPACITY   ACCESSMODES   STATUS    CLAIM                  REASON    AGE</span><br><span class="line">nfs-glassfish   300Mi      RWX           Bound     default/glassfishnfs             9d</span><br><span class="line">[root@master pvc]# kubectl get pvc glassfishnfs</span><br><span class="line">NAME           STATUS    VOLUME          CAPACITY   ACCESSMODES   AGE</span><br><span class="line">glassfishnfs   Bound     nfs-glassfish   300Mi      RWX           9d</span><br></pre></td></tr></table></figure>

<h4 id="4、部署glassfish"><a href="#4、部署glassfish" class="headerlink" title="4、部署glassfish"></a>4、部署glassfish</h4><p>镜像创建好只后，就开始编写yaml文件来生成rc和svc，下面是配置文件：<br><em>glassfish-rc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">kind: ReplicationController</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: xxx-glassfish</span><br><span class="line">  labels:</span><br><span class="line">    name: xxx-glassfish</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    name: xxx-glassfish</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: xxx-glassfish</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: glassfish</span><br><span class="line">        image: glassfish:z1</span><br><span class="line">        ports:</span><br><span class="line">        - name: http-server</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: manage-server</span><br><span class="line">          containerPort: 4848</span><br><span class="line">        env:</span><br><span class="line">        - name: GLASSFISH_PASS</span><br><span class="line">          value: &#x27;111111&#x27;</span><br><span class="line">        - name: DBUSER</span><br><span class="line">          value: root</span><br><span class="line">        - name: DBPWD</span><br><span class="line">          value: abcd1234</span><br><span class="line">        - name: DBPORT</span><br><span class="line">          value: &#x27;3306&#x27;</span><br><span class="line">        - name: DBHOST</span><br><span class="line">          value: xxx-mysql</span><br><span class="line">        - name: DBNAME</span><br><span class="line">          value: bar</span><br><span class="line">        - name: JDBC_POOL</span><br><span class="line">          value: bar</span><br><span class="line">        - name: JDBC_NAME</span><br><span class="line">          value: bar</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: gf-persistent-storage</span><br><span class="line">          mountPath: /opt/file</span><br><span class="line">      volumes:</span><br><span class="line">      - name: gf-persistent-storage</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: glassfishnfs</span><br></pre></td></tr></table></figure>
<p><em>glassfish-svc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: xxx-glassfish</span><br><span class="line">  name: xxx-glassfish</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: manage</span><br><span class="line">      targetPort: 4848</span><br><span class="line">      port: 4848</span><br><span class="line">      nodePort: 30048</span><br><span class="line">    - name: server</span><br><span class="line">      port: 8080</span><br><span class="line">      targetPort: 8080</span><br><span class="line">      nodePort: 30058</span><br><span class="line">  selector:</span><br><span class="line">    name: xxx-glassfish</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>
<p>通过kubectl创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master llml]# kubectl create -f glassfish-rc.yaml </span><br><span class="line">replicationcontroller &quot;xxx-glassfish&quot; created</span><br><span class="line">[root@master llml]# kubectl create -f glassfish-svc.yaml </span><br><span class="line">You have exposed your service on an external port on all nodes in your</span><br><span class="line">cluster.  If you want to expose this service to the external internet, you may</span><br><span class="line">need to set up firewall rules for the service port(s) (tcp:30048,tcp:30058) to serve traffic.</span><br><span class="line"></span><br><span class="line">See http://releases.k8s.io/release-1.2/docs/user-guide/services-firewalls.md for more details.</span><br><span class="line">service &quot;xxx-glassfish&quot; created</span><br></pre></td></tr></table></figure>
<p>创建完成后可以在客户端测试：<a href="https://nodeIP:30048,看到如下界面，部署成功。">https://nodeIP:30048,看到如下界面，部署成功。</a><br><img src="/uploads/shili2-2.png" alt="shili2-2"></p>
<h3 id="三、openfire部署"><a href="#三、openfire部署" class="headerlink" title="三、openfire部署"></a>三、openfire部署</h3><p>这里要求的版本是4.0.2，由于此项目对openfire进行了二次开发，所以不能使用现成的镜像，必须手动创建镜像。<br>创建镜像时我们使用jdk1.8的基础包</p>
<h4 id="1、下载jdk镜像"><a href="#1、下载jdk镜像" class="headerlink" title="1、下载jdk镜像"></a>1、下载jdk镜像</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull index.tenxcloud.com/gavincook/java:8u60</span><br></pre></td></tr></table></figure>
<h4 id="2、创建镜像"><a href="#2、创建镜像" class="headerlink" title="2、创建镜像"></a>2、创建镜像</h4><p>在创建镜像时我们把二次开发的openfire包ADD到images中，连接前面mysql恢复的数据库，这样操作openfire的管理员账号密码都是数据库里固定的，创建RC时无法自定义。<br>下面是Dockerfile文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM index.tenxcloud.com/gavincook/java:8u60</span><br><span class="line">MAINTAINER zhanghong,zhanghong@16feng.com</span><br><span class="line"># tar包add后自动解压缩</span><br><span class="line">ADD openfire.tar /opt/</span><br><span class="line">ADD run.sh /</span><br><span class="line">RUN chmod +x /run.sh</span><br><span class="line">EXPOSE 9090 7070</span><br><span class="line">ENTRYPOINT [&quot;/run.sh&quot;]</span><br></pre></td></tr></table></figure>
<p>run.sh启动脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">#configure the db-connect</span><br><span class="line">#把openfire.xml中的预定义字段通过环境变量进行替换</span><br><span class="line">sed -i &quot;s/DB_HOST/$DBHOST/&quot; /opt/openfire/conf/openfire.xml</span><br><span class="line">sed -i &quot;s/DB_PORT/$DBPORT/&quot; /opt/openfire/conf/openfire.xml</span><br><span class="line">sed -i &quot;s/DB_NAME/$DBNAME/&quot; /opt/openfire/conf/openfire.xml</span><br><span class="line">sed -i &quot;s/DB_USER/$DBUSER/&quot; /opt/openfire/conf/openfire.xml</span><br><span class="line">sed -i &quot;s/DB_PWD/$DBPWD/&quot; /opt/openfire/conf/openfire.xml</span><br><span class="line"></span><br><span class="line">#start openfire</span><br><span class="line">sh /opt/openfire/bin/openfire.sh</span><br></pre></td></tr></table></figure>
<p>这是我dockerfile目录文件的情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@minion2 openfire]# ll</span><br><span class="line">总用量 225048</span><br><span class="line">-rw-r--r--. 1 root root       184 7月  25 17:41 Dockerfile</span><br><span class="line">-rw-r--r--. 1 root root 230440960 7月  26 13:53 openfire.tar</span><br><span class="line">-rw-r--r--. 1 root root       399 7月  26 13:53 run.sh</span><br></pre></td></tr></table></figure>
<p>通过docker build 生成项目专用openfire镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@minion2 openfire]# docker build -t openfire:z1 .</span><br><span class="line">Sending build context to Docker daemon 230.4 MB</span><br><span class="line">Step 1 : FROM index.tenxcloud.com/gavincook/java:8u60</span><br><span class="line"> ---&gt; 66d5d2bef939</span><br><span class="line">Step 2 : MAINTAINER zhanghong,zhanghong@16feng.com</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; da436dd979e4</span><br><span class="line">Step 3 : ADD openfire.tar /opt/</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; cb62b8ef982e</span><br><span class="line">Step 4 : ADD run.sh /</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 13576f06c104</span><br><span class="line">Step 5 : RUN chmod +x /run.sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 4f01a8feee4d</span><br><span class="line">Step 6 : EXPOSE 9090 7070</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 7414e75b17a8</span><br><span class="line">Step 7 : ENTRYPOINT /run.sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; bae1ec475705</span><br><span class="line">Successfully built bae1ec475705</span><br></pre></td></tr></table></figure>
<h4 id="6、开始部署openfire"><a href="#6、开始部署openfire" class="headerlink" title="6、开始部署openfire"></a>6、开始部署openfire</h4><p>下面是rc和svc配置文件：<br><em>openfire-rc.yaml</em></p>
<figure class="highlight plaintext"><figcaption><span>ReplicationController</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: xxx-openfire</span><br><span class="line">  labels:</span><br><span class="line">    name: xxx-openfire</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    name: xxx-openfire</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: xxx-openfire</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: openfire</span><br><span class="line">        image: openfire:z1</span><br><span class="line">        ports:</span><br><span class="line">        - name: http-server</span><br><span class="line">          containerPort: 7070</span><br><span class="line">        - name: manage-server</span><br><span class="line">          containerPort: 9090</span><br><span class="line">        env:</span><br><span class="line">        - name: DBHOST</span><br><span class="line">          value: xxx-mysql</span><br><span class="line">        - name: DBUSER</span><br><span class="line">          value: root</span><br><span class="line">        - name: DBPWD</span><br><span class="line">          value: abcd1234</span><br><span class="line">        - name: DBPORT</span><br><span class="line">          value: &#x27;3306&#x27;</span><br><span class="line">        - name: DBNAME</span><br><span class="line">          value: bar</span><br></pre></td></tr></table></figure>
<p><em>openfire-svc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: xxx-openfire</span><br><span class="line">  name: xxx-openfire</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: manage</span><br><span class="line">      targetPort: 9090</span><br><span class="line">      port: 9090</span><br><span class="line">      nodePort: 30090</span><br><span class="line">    - name: server</span><br><span class="line">      port: 7070</span><br><span class="line">      targetPort: 7070</span><br><span class="line">      nodePort: 30070</span><br><span class="line">  selector:</span><br><span class="line">    name: xxx-openfire</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>
<p>通过kubectl创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master llml]# kubectl create -f openfire-rc.yaml</span><br><span class="line">replicationcontroller &quot;xxx-openfire&quot; created</span><br><span class="line">[root@master llml]# kubectl create -f openfire-svc.yaml</span><br><span class="line">You have exposed your service on an external port on all nodes in your</span><br><span class="line">cluster. If you want to expose this service to the external internet, you may</span><br><span class="line">need to set up firewall rules for the service port(s) (tcp:30090,tcp:30070) to serve traffic.</span><br><span class="line"></span><br><span class="line">See http://releases.k8s.io/release-1.2/docs/user-guide/services-firewalls.md for more details.</span><br><span class="line">service &quot;xxx-openfire&quot; created</span><br></pre></td></tr></table></figure>
<h3 id="四、nginx部署"><a href="#四、nginx部署" class="headerlink" title="四、nginx部署"></a>四、nginx部署</h3><h4 id="1、下载镜像-2"><a href="#1、下载镜像-2" class="headerlink" title="1、下载镜像"></a>1、下载镜像</h4><p>nginx镜像使用一个稳定版本即可，这里从时速云下载一个最新版本，此版本是1.9.15</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull index.tenxcloud.com/docker_library/nginx:latest</span><br></pre></td></tr></table></figure>
<h4 id="2、构建镜像"><a href="#2、构建镜像" class="headerlink" title="2、构建镜像"></a>2、构建镜像</h4><p>对于nginx镜像还是要进行二次构建，以便把自定义的配置文件加载到镜像里。<br><em>Dockerfile</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM index.tenxcloud.com/docker_library/nginx:latest</span><br><span class="line">MAINTAINER zhanghong,zhanghonged@126.com</span><br><span class="line">#添加自定义配置文件</span><br><span class="line">ADD llml.conf /etc/nginx/conf.d</span><br><span class="line">#添加启动脚本</span><br><span class="line">ADD run.sh /</span><br><span class="line">RUN chmod +x /run.sh</span><br><span class="line">RUN rm -rf /etc/nginx/conf.d/default.conf</span><br><span class="line">RUN echo &quot;Asia/shanghai&quot; &gt;&gt; /etc/timezone</span><br><span class="line">#创建web文件目录</span><br><span class="line">RUN mkdir -p /opt/nginx/liliweb</span><br><span class="line">RUN ln -sf /dev/stdout /var/log/nginx/access.log</span><br><span class="line">RUN ln -sf /dev/stderr /var/log/nginx/error.log</span><br><span class="line">EXPOSE 80</span><br><span class="line">ENTRYPOINT [&quot;/run.sh&quot;]</span><br></pre></td></tr></table></figure>
<p>自定义配置文件llml.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">server  &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        root /opt/nginx/liliweb;</span><br><span class="line">        index index.html;</span><br><span class="line"></span><br><span class="line">        access_log off;     </span><br><span class="line"></span><br><span class="line">        #用户上传文件目录，此目录下文件通过glassfish上传到系统，然后nginx来调用显示</span><br><span class="line">        location /img &#123;</span><br><span class="line">        alias /opt/file/img;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /api &#123;</span><br><span class="line">        #此处的GF_HOST在容器启动时通过环境变量进行替换</span><br><span class="line">        proxy_pass http://GF_HOST:8080/bar/api;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-real-ip $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        client_max_body_size 1025m;</span><br><span class="line">        client_body_buffer_size 128k;</span><br><span class="line">        client_body_temp_path   /tmp/nginx_temp;</span><br><span class="line">        proxy_connect_timeout 900;</span><br><span class="line">        proxy_send_timeout 900;</span><br><span class="line">        proxy_read_timeout 900;</span><br><span class="line">        proxy_buffer_size 4k;</span><br><span class="line">        proxy_buffers 4 64k;</span><br><span class="line">        proxy_busy_buffers_size 128k;</span><br><span class="line">        proxy_temp_file_write_size 64k;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动脚本run.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#替换llml.conf中的预定义位置&quot;GF_HOST&quot;</span><br><span class="line">#$GLASSFISH_HOST是在rc中定义的环境变量</span><br><span class="line">sed -i &quot;s/GF_HOST/$GLASSFISH_HOST/&quot; /etc/nginx/conf.d/llml.conf</span><br><span class="line"></span><br><span class="line">nginx -g &quot;daemon off;&quot;</span><br></pre></td></tr></table></figure>
<p>通过docker build 生成镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@minion2 nginx]# docker build -t nginx1.9.15:z1 .</span><br><span class="line">Sending build context to Docker daemon 4.608 kB</span><br><span class="line">Step 1 : FROM index.tenxcloud.com/docker_library/nginx:latest</span><br><span class="line"> ---&gt; 6f8d099c3adc</span><br><span class="line">Step 2 : MAINTAINER zhanghong,zhanghonged@126.com</span><br><span class="line"> ---&gt; Running in d4ca4cab0b1a</span><br><span class="line"> ---&gt; d76a295fff3f</span><br><span class="line">Removing intermediate container d4ca4cab0b1a</span><br><span class="line">Step 3 : ADD llml.conf /etc/nginx/conf.d</span><br><span class="line"> ---&gt; a967240204fd</span><br><span class="line">Removing intermediate container 1282851f1a57</span><br><span class="line">Step 4 : ADD run.sh /</span><br><span class="line"> ---&gt; edcec3007425</span><br><span class="line">Removing intermediate container df13310f6981</span><br><span class="line">Step 5 : RUN chmod +x /run.sh</span><br><span class="line"> ---&gt; Running in 268ef45081f5</span><br><span class="line"> ---&gt; 680b68e5ae12</span><br><span class="line">Removing intermediate container 268ef45081f5</span><br><span class="line">Step 6 : RUN rm -rf /etc/nginx/conf.d/default.conf</span><br><span class="line"> ---&gt; Running in 0df4ea2645d6</span><br><span class="line"> ---&gt; 2db08084d7d7</span><br><span class="line">Removing intermediate container 0df4ea2645d6</span><br><span class="line">Step 7 : RUN echo &quot;Asia/shanghai&quot; &gt;&gt; /etc/timezone</span><br><span class="line"> ---&gt; Running in a1b49b8991ac</span><br><span class="line"> ---&gt; 9425d965b6ad</span><br><span class="line">Removing intermediate container a1b49b8991ac</span><br><span class="line">Step 8 : RUN mkdir -p /opt/nginx/liliweb</span><br><span class="line"> ---&gt; Running in 847a375c404d</span><br><span class="line"> ---&gt; 723ea8dba07a</span><br><span class="line">Removing intermediate container 847a375c404d</span><br><span class="line">Step 9 : RUN ln -sf /dev/stdout /var/log/nginx/access.log</span><br><span class="line"> ---&gt; Running in 1a7631a398ae</span><br><span class="line"> ---&gt; 6e0f8c92aa61</span><br><span class="line">Removing intermediate container 1a7631a398ae</span><br><span class="line">Step 10 : RUN ln -sf /dev/stderr /var/log/nginx/error.log</span><br><span class="line"> ---&gt; Running in 884ed10c5a96</span><br><span class="line"> ---&gt; 3fef15580b64</span><br><span class="line">Removing intermediate container 884ed10c5a96</span><br><span class="line">Step 11 : EXPOSE 80</span><br><span class="line"> ---&gt; Running in 31d7e126cb80</span><br><span class="line"> ---&gt; 41e5bcb6857e</span><br><span class="line">Removing intermediate container 31d7e126cb80</span><br><span class="line">Step 12 : ENTRYPOINT /run.sh</span><br><span class="line"> ---&gt; Running in 806e888846a2</span><br><span class="line"> ---&gt; d05c3d3ac077</span><br><span class="line">Removing intermediate container 806e888846a2</span><br><span class="line">Successfully built d05c3d3ac077</span><br></pre></td></tr></table></figure>

<h4 id="3、创建nginx的持久化存储pv及pvc"><a href="#3、创建nginx的持久化存储pv及pvc" class="headerlink" title="3、创建nginx的持久化存储pv及pvc"></a>3、创建nginx的持久化存储pv及pvc</h4><p><em>nginx-pv.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-nginx</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 200Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    server: 192.168.1.4</span><br><span class="line">    path: &quot;/data/k8s/nginx&quot;&lt;/pre&gt;</span><br><span class="line">nginx-pvc.yaml</span><br><span class="line">&lt;pre class=&quot;lang:default decode:true &quot;&gt;kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginxnfs</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 200Mi</span><br></pre></td></tr></table></figure>
<p>使用kubectl create来创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master pvc]# kubectl create -f nginx-pv.yaml </span><br><span class="line">[root@master pvc]# kubectl create -f nginx-pvc.yaml </span><br><span class="line">[root@master pvc]# kubectl get pv nfs-nginx</span><br><span class="line">NAME        CAPACITY   ACCESSMODES   STATUS    CLAIM              REASON    AGE</span><br><span class="line">nfs-nginx   200Mi      RWX           Bound     default/nginxnfs             5d</span><br><span class="line">[root@master pvc]# kubectl get pvc nginxnfs</span><br><span class="line">NAME       STATUS    VOLUME      CAPACITY   ACCESSMODES   AGE</span><br><span class="line">nginxnfs   Bound     nfs-nginx   200Mi      RWX           5d</span><br></pre></td></tr></table></figure>
<h4 id="4、使用kubectl-create-来进行部署"><a href="#4、使用kubectl-create-来进行部署" class="headerlink" title="4、使用kubectl create 来进行部署"></a>4、使用kubectl create 来进行部署</h4><p>下面是rc和svc的yaml文件：<br><em>nginx-rc.yaml</em><br>此文件需要挂载两处volume，nginx的web目录和上面glassfish挂载的文件目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kind: ReplicationController</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: xxx-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: xxx-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx1.9.15:z1</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">        env:</span><br><span class="line">        - name: GLASSFISH_HOST</span><br><span class="line">          value: xxx-glassfish</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nginx-persistent-storage</span><br><span class="line">          mountPath: /opt/nginx/liliweb</span><br><span class="line">        - name: gf-persistent-storage</span><br><span class="line">          mountPath: /opt/file</span><br><span class="line">      volumes:</span><br><span class="line">      - name: nginx-persistent-storage</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: nginxnfs</span><br><span class="line">      - name: gf-persistent-storage</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: glassfishnfs</span><br></pre></td></tr></table></figure>
<p><em>nginx-svc.yaml</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: xxx-nginx</span><br><span class="line">  name: xxx-nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - targetPort: 80</span><br><span class="line">      port: 80</span><br><span class="line">      nodePort: 30080</span><br><span class="line">  selector:</span><br><span class="line">    name: xxx-nginx</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>
<p>创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master llml]# kubectl create -f nginx-rc.yaml </span><br><span class="line">replicationcontroller &quot;xxx-nginx&quot; created</span><br><span class="line">[root@master llml]# kubectl create -f nginx-svc.yaml </span><br><span class="line">You have exposed your service on an external port on all nodes in your</span><br><span class="line">cluster.  If you want to expose this service to the external internet, you may</span><br><span class="line">need to set up firewall rules for the service port(s) (tcp:30080) to serve traffic.</span><br><span class="line"></span><br><span class="line">See http://releases.k8s.io/release-1.2/docs/user-guide/services-firewalls.md for more details.</span><br><span class="line">service &quot;xxx-nginx&quot; created</span><br></pre></td></tr></table></figure>
<p>创建完后可以通过<a href="http://node:30080来访问测试，可以看到nginx默认欢迎页表示部署成功。">http://node:30080来访问测试，可以看到nginx默认欢迎页表示部署成功。</a></p>
<p>目前为止环境包含的各个模块部署完毕。</p>
<h2 id="程序发布"><a href="#程序发布" class="headerlink" title="程序发布:"></a>程序发布:</h2><p>此模块主要是部署应用程序，这里简单介绍下：<br>nginx：web文件拷贝到nfs server的&#x2F;data&#x2F;k8s&#x2F;nginx目录下，以后更新也是对这个目录进行更新。<br>glassfish：</p>
<ul>
<li>1、把打好的.war包通过命令进行发布，由于glassfish挂载了nfs server的&#x2F;data&#x2F;k8s&#x2F;gf目录，把.war包放在这个目录，然后通过命令asadmin -W &#x2F;etc&#x2F;gfpwd deploy xxx.bar进行部署。</li>
<li>2、把程序预定义的一些相关文件拷贝到nfs server的&#x2F;data&#x2F;k8s&#x2F;gf目录。</li>
</ul>
<p>openfire：不用部署，程序启动即可。<br>mysql：之前初始话.sql脚本已经恢复，不用再部署。</p>
<p>到此项目部署完毕，经测试可以正常使用。<br>现在正是初学k8s阶段，对于此环境有什么需要改进的地方请不吝赐教，谢谢。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/%E5%AE%9E%E4%BE%8B/" rel="tag"># 实例</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2016/07/29/kubelet%E6%8A%A5%E9%94%99%EF%BC%9A%20failed%20to%20detect%20process%20id%20for%20docker%20%E2%80%93%20failed%20to%20find%20pid%20of%20docker%20exit%20status%201/" rel="prev" title="kubelet报错： failed to detect process id for ">
                  <i class="fa fa-chevron-left"></i> kubelet报错： failed to detect process id for 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2016/08/03/centos7_x64%20%E4%B8%8B%E9%85%8D%E7%BD%AEpython3.5/" rel="next" title="centos7_x64 下配置python3.5">
                  centos7_x64 下配置python3.5 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张大秀</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
